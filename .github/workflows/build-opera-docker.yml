
# æè¿°ï¼šä½¿ç”¨ GitHub Actions æ„å»º OpenWrt
#

åç§°ï¼šæ„å»º x86_64 OpenWrt 5.19

ä¸Šï¼š
  å­˜å‚¨åº“è°ƒåº¦ï¼š
  å·¥ä½œæµè°ƒåº¦ï¼š
    è¾“å…¥ï¼š
      SSHï¼š
        æè¿°ï¼š'SSH è¿æ¥åˆ°æ“ä½œ'
        å¿…éœ€ï¼šå‡
        é»˜è®¤å€¼ï¼š'å‡'

ç¯å¢ƒï¼š
  REPO_URLï¼šhttps://github.com/coolsnowwolf/lede
  REPO_BRANCHï¼šä¸»
  FEEDS_CONFï¼šfeeds.conf.default
  CONFIG_FILEï¼šdocker-x86_64.config
  DIY_P1_SHï¼šdiy-part1.sh
  DIY_P2_SHï¼šdiy-part2.sh
  UPLOAD_FIRMWAREï¼šçœŸ
  UPLOAD_RELEASEï¼šå‡
  TZï¼šäºšæ´²/ä¸Šæµ·

å·¥ä½œï¼š
  æµ‹è¯•ï¼š
    è¿è¡Œï¼šubuntu-20.04
    è¶…æ—¶åˆ†é’Ÿæ•°ï¼š560
    
    è„šæ­¥ï¼š
    - åç§°ï¼šç»“å¸
      ç”¨é€”ï¼šactions/checkout@v3

    - åç§°ï¼šåˆå§‹åŒ–ç¯å¢ƒ
      ç¯å¢ƒï¼š
        DEBIAN_FRONTENDï¼šéäº¤äº’å¼
      è¿è¡Œï¼š|
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq æ›´æ–°
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2004)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        é¡»è—¤ mkdir -p /å·¥ä½œç›®å½•
        sudo chown $USER:$GROUPS /workdir
    - åç§°ï¼šå…‹éš†æºä»£ç 
      å·¥ä½œç›®å½•ï¼š/workdir
      è¿è¡Œï¼š|
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        
    - åç§°ï¼šluci-theme-argon å®‰è£…
      è¿è¡Œï¼š|
       cd openwrt
       cd åŒ…/ç²¾ç›Š  
       rm -rf luci-ä¸»é¢˜-æ°©  
       git clone -b 18.06 https://github.com/jerrykuku/luci-theme-argon.git
     
    - åç§°ï¼šåŠ è½½è‡ªå®šä¹‰æè¦
      è¿è¡Œï¼š|
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH
        
    - åç§°ï¼šæ›´æ–°æè¦
      è¿è¡Œï¼š cd openwrt && ./scripts/feeds update -a

    - åç§°ï¼šå®‰è£…æè¦
      è¿è¡Œï¼š cd openwrt && ./scripts/feeds install -a

    - åç§°ï¼šåŠ è½½è‡ªå®šä¹‰é…ç½®
      è¿è¡Œï¼š|
        [ -e æ–‡ä»¶ ] && mv æ–‡ä»¶ openwrt/æ–‡ä»¶
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
    - åç§°ï¼šåˆ° Actions çš„ SSH è¿æ¥
      ç”¨é€”ï¼šP3TERX/ssh2actions@v1.0.0
      å¦‚æœ: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh != 'false') || åŒ…å«ï¼ˆgithub.event.actionï¼Œ'ssh'ï¼‰
      ç¯å¢ƒï¼š
        TELEGRAM_CHAT_IDï¼š${{ ç§˜å¯†.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKENï¼š${{ ç§˜å¯†.TELEGRAM_BOT_TOKEN }}

    - åç§°ï¼šä¸‹è½½åŒ…
      ç¼–å·ï¼šåŒ…è£¹
      è¿è¡Œï¼š|
        cd openwrt
        ä½¿å®šä¹‰é…ç½®
        ä½¿ä¸‹è½½-j8
        æŸ¥æ‰¾ dl -size -1024c -exec ls -l {} \;
        æŸ¥æ‰¾ dl -size -1024c -exec rm -f {} \;
        
    - åç§°ï¼šç¼–è¯‘å›ºä»¶
      idï¼šç¼–è¯‘
      è¿è¡Œï¼š|
        cd openwrt
        echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘"
        ä½¿-j$(nproc) || ä½¿-j1 || ä½¿-j1 V=s
        å›å£°â€œçŠ¶æ€=æˆåŠŸâ€>> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        
    - åç§°ï¼šæ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      å¦‚æœï¼šï¼ˆï¼å–æ¶ˆï¼ˆï¼‰ï¼‰
      è¿è¡Œï¼šdf -hT

    - åç§°ï¼šç»„ç»‡æ–‡ä»¶
      id: ç»„ç»‡
      å¦‚æœï¼šenv.UPLOAD_FIRMWARE == 'true' && !cancelled()
      è¿è¡Œï¼š|
        cd openwrt/bin/targets/*/*
        rm -rf è½¯ä»¶åŒ…
        å›å£°â€œFIRMWARE=$PWDâ€>> $GITHUB_ENV
        å›å£°â€œçŠ¶æ€=æˆåŠŸâ€>> $GITHUB_OUTPUT
        
    - åç§°ï¼šä¸Šä¼ å›ºä»¶ç›®å½•
      ç”¨é€”ï¼šåŠ¨ä½œ/ä¸Šä¼ -artifact@v3
      å¦‚æœï¼šsteps.organize.outputs.status == 'success' && !cancelled()
      å’Œï¼š
        åç§°ï¼šOpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        è·¯å¾„ï¼š${{ env.FIRMWARE }}

    - åç§°ï¼šç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      ç¼–å·ï¼šæ ‡ç­¾
      å¦‚æœï¼š env.UPLOAD_RELEASE == 'true' && !cancelled()
      è¿è¡Œï¼š|
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        è§¦æ‘¸é‡Šæ”¾.txt
        [ $UPLOAD_COWTRANSFER = true ] && echo "ğŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
        [ $UPLOAD_WETRANSFER = true ] && echo "ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
        å›å£°â€œçŠ¶æ€=æˆåŠŸâ€>> $GITHUB_OUTPUT
        
    - åç§°ï¼šä¸Šä¼ å›ºä»¶ä»¥å‘å¸ƒ
      ç”¨é€”ï¼šsoftprops/action-gh-release@v1
      å¦‚æœï¼šsteps.tag.outputs.status == 'success' && !cancelled()
      ç¯å¢ƒï¼š
        GITHUB_TOKEN: ${{ ç§˜å¯†.GITHUB_TOKEN }}
      å’Œï¼š
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_pathï¼šrelease.txt
        æ–‡ä»¶ï¼š${{ env.FIRMWARE }}/*

# - åç§°ï¼šåˆ é™¤å·¥ä½œæµè¿è¡Œ
# ç”¨é€”ï¼šGitRML/delete-workflow-runs@main
ï¼ƒ å’Œï¼š
# ä¿ç•™å¤©æ•°ï¼š30
# keep_minimum_runs: 30

    - åç§°ï¼šåˆ é™¤æ—§ç‰ˆæœ¬
      ç”¨é€”ï¼šdev-drprasad/delete-older-releases@v0.1.0
      å¦‚æœï¼š env.UPLOAD_RELEASE == 'true' && !cancelled()
      å’Œï¼š
        ä¿æŒæœ€æ–°ï¼š30
        åˆ é™¤æ ‡ç­¾ï¼šçœŸ
      ç¯å¢ƒï¼š
        GITHUB_TOKEN: ${{ ç§˜å¯†.GITHUB_TOKEN }}

